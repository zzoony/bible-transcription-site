# Sub Agent 활용 규칙 - 콘텐츠 확장용

**목적**: 성경 구절 분석 콘텐츠 확장 시 Sub Agent를 최대한 활용하여 효율성과 품질을 보장

**적용 범위**: 모든 성경책 및 장별 구절 분석 작업

**규칙 수립일**: 2025-09-29
**기반 데이터**: 빌립보서 3장 병렬 처리 성과 (75% 시간 단축, 100% 성공률)

---

## 🎯 핵심 원칙

### 1. Sub Agent 최우선 활용
- **모든 콘텐츠 확장 작업은 반드시 Sub Agent 병렬 처리로 진행**
- 단일 구절 처리도 향후 병렬 확장을 고려한 구조로 설계
- 순차 처리는 기술적 제약이나 디버깅 목적에서만 예외적으로 사용

### 2. **데이터 완결성 최우선 보장** ⚠️ **CRITICAL RULE**
- **완료 선언 전 반드시 모든 대상 구절의 데이터베이스 저장 검증**
- Sub Agent 완료 보고와 실제 DB 저장 간 100% 일치 확인 필수
- 누락 구절 발견 시 즉시 복구 작업 실행 후 완료 선언
- **"Agent가 완료했다고 보고 ≠ 실제 완료"** - 반드시 DB 검증

### 3. 품질 우선, 속도 보완
- Sub Agent 활용으로 속도를 높이되 품질 저하 방지
- 각 Agent는 동일한 분석 표준(Schema v2) 준수
- 자동 품질 검증 시스템으로 일관성 보장

### 4. 확장성 고려 설계
- 새로운 성경책 추가 시 즉시 적용 가능한 범용적 구조
- Agent 수 및 그룹핑 전략의 동적 조정 가능
- 대용량 처리(전체 성경)까지 확장 가능한 아키텍처

---

## 📊 Agent 수 결정 공식

### 기본 공식
```
최적 Agent 수 = min(구절수 ÷ 5, 8)
최소 Agent 수 = max(구절수 ÷ 10, 2)
```

### 구절 수별 권장 Agent 구성
| 구절 수 | 권장 Agent 수 | 그룹 크기 | 예상 처리 시간 |
|---------|-------------|-----------|---------------|
| 1-10개 | 2개 | 5개씩 | ~2-3분 |
| 11-20개 | 3-4개 | 5-7개씩 | ~3-5분 |
| 21-30개 | 4-6개 | 5-8개씩 | ~4-6분 |
| 31-50개 | 6-8개 | 6-8개씩 | ~5-8분 |
| 51개 이상 | 8개 (최대) | 7-10개씩 | ~8-12분 |

### 실제 적용 예시
- **빌립보서 1장** (30개): **6개 Agent** 권장
- **빌립보서 2장** (30개): **6개 Agent** 권장
- **빌립보서 4장** (23개): **4-5개 Agent** 권장

---

## 🎭 의미 단위별 그룹핑 전략

### 1. 신학적 주제별 그룹핑 (최우선)
- 동일한 신학적 주제나 문맥을 가진 구절들을 하나의 그룹으로 구성
- 바울서신의 경우 논증 구조를 고려한 그룹핑
- 복음서의 경우 에피소드나 가르침 단위별 그룹핑

### 2. 문학적 구조 고려
- 문단(paragraph) 단위 기준
- 시편의 경우 스탄자(stanza) 단위
- 내러티브의 경우 장면(scene) 단위

### 3. 균등 분배 보완
- 의미 단위 우선이되 Agent 간 작업량이 과도하게 불균등하지 않도록 조정
- 최대 작업량 차이: 3개 구절 이내 유지

### 4. 빌립보서 1장 그룹핑 예시 (30개 구절 → 6개 Agent)
```
Agent 1: 1:1-1:6   (인사와 감사, 6개)
Agent 2: 1:7-1:11  (사랑과 기도, 5개)
Agent 3: 1:12-1:18 (복음 전진, 7개)
Agent 4: 1:19-1:26 (삶과 죽음, 8개)
Agent 5: 1:27-1:30 (복음에 합당한 행실, 4개)
```

---

## ⚡ 성능 최적화 전략

### 1. API Rate Limit 관리
- Agent 간 시작 시간 1초 간격 조정
- 각 구절 처리 후 2초 딜레이 유지
- API 호출 실패 시 지수적 백오프(exponential backoff) 적용

### 2. 메모리 사용량 최적화
- 동시 실행 Agent 수 최대 8개로 제한
- 각 Agent는 처리 완료 후 즉시 메모리 정리
- 대용량 텍스트 처리 시 청크 단위 분할

### 3. 데이터베이스 최적화
- Connection pooling 활용으로 동시 접근 최적화
- 트랜잭션 충돌 방지를 위한 격리 수준 설정
- 배치 Insert 활용으로 DB 부하 감소

### 4. 네트워크 안정성
- 자동 재시도 로직 (최대 3회)
- 일시적 네트워크 오류 시 대기 후 재시도
- 실패한 구절에 대한 별도 재처리 큐 운영

---

## 🛡️ 품질 보장 시스템

### 1. 실시간 품질 검증
- 각 구절 처리 완료 즉시 형식 검증
- Schema v2 준수 여부 자동 확인
- 필수 필드 누락 시 즉시 재처리 요청

### 2. 일관성 검증
- 동일 Agent 내 구절 간 분석 스타일 일관성 점검
- 전체 완료 후 교차 검증으로 Agent 간 일관성 확인
- 용어 사용 통일성 검증 (예: 동일 단어의 분석 일관성)

### 3. 샘플링 품질 검증
- 무작위 샘플링으로 10% 구절에 대한 상세 품질 점검
- 신학적 정확성, 언어학적 정확성, 사용자 친화성 평가
- 품질 점수 7점 이하 시 해당 Agent 작업 전체 재검토

### 4. 인간 검토 트리거
- API 오류율 20% 초과 시
- 품질 점수 평균 8점 미만 시
- 사용자 피드백이나 오류 신고 시

---

## 🔄 오류 복구 및 재시도 전략

### 1. 자동 재시도 정책
```
1차 실패: 5초 대기 후 재시도
2차 실패: 15초 대기 후 재시도
3차 실패: 60초 대기 후 재시도
4차 실패: 수동 개입 필요 알림
```

### 2. 실패 유형별 대응
- **API Rate Limit**: 대기 시간 증가 후 재시도
- **네트워크 오류**: 즉시 재시도 후 대기 시간 증가
- **데이터베이스 오류**: 연결 재설정 후 재시도
- **분석 품질 오류**: 프롬프트 조정 후 재시도

### 3. 부분 실패 처리
- 전체 중단 없이 성공한 구절은 유지
- 실패한 구절만 별도 처리 큐로 이동
- 전체 완료 후 실패 구절 일괄 재처리

### 4. 복구 불가능 오류 처리
- 수동 개입 필요 알림 발송
- 상세 오류 로그 생성 및 저장
- 임시 스킵 후 나중에 별도 처리

---

## 📈 진행 상황 모니터링

### 1. 실시간 대시보드
- 각 Agent별 처리 진행률 실시간 표시
- 성공/실패/재시도 상태 시각화
- 예상 완료 시간 동적 계산

### 2. 상세 로깅
- 각 구절별 처리 시작/완료 시간 기록
- API 호출 횟수 및 응답 시간 기록
- 오류 발생 시점 및 원인 상세 기록

### 3. 성능 메트릭 수집
- 전체 처리 시간 및 Agent별 처리 시간
- API 성공률 및 평균 응답 시간
- 메모리 사용량 및 CPU 사용률 모니터링

### 4. 자동 알림 시스템
- 처리 완료 시 성공 알림
- 오류 발생 시 즉시 알림
- 예상 시간 초과 시 지연 알림

---

## 🚀 확장성 및 미래 계획

### 1. 성경책별 확장 계획
```
Phase 3A: 빌립보서 완성 (1,2,4장)
Phase 3B: 갈라디아서 6장 (6×10-15개 Agent)
Phase 3C: 로마서 16장 (16×8-12개 Agent)
Phase 4: 신약 전체 (27권×평균 10개 Agent)
Phase 5: 구약 포함 전체 성경
```

### 2. 기술적 확장성
- 클라우드 인프라로 확장 시 Agent 수 동적 증가 가능
- Kubernetes 기반 Auto-scaling 적용 가능
- 다중 Claude API 키 활용으로 Rate Limit 확장

### 3. 분석 품질 향상
- 기계학습 기반 품질 평가 시스템 도입
- 사용자 피드백 기반 분석 개선
- 다국어 번역 확장 (중국어, 일본어 등)

### 4. 사용자 경험 확장
- 실시간 처리 진행률 웹 UI 제공
- 개인화된 분석 요청 시스템
- 커뮤니티 기반 품질 검증 참여

---

## 📋 체크리스트 템플릿

### 콘텐츠 확장 작업 시작 전
- [ ] 대상 성경책/장의 구절 수 확인
- [ ] 최적 Agent 수 계산 (공식 적용)
- [ ] 의미 단위별 그룹핑 전략 수립
- [ ] NIV 원문 텍스트 준비
- [ ] 데이터베이스 연결 및 스키마 확인
- [ ] 모니터링 시스템 준비

### 병렬 처리 실행 중
- [ ] 각 Agent 시작 시간 1초 간격 조정
- [ ] 실시간 진행 상황 모니터링
- [ ] 오류 발생 시 즉시 대응
- [ ] API Rate Limit 준수 확인
- [ ] 메모리 사용량 모니터링

### ⚠️ **작업 완료 전 필수 검증** (CRITICAL)
- [ ] **데이터베이스 구절 수 확인**: 예상 구절 수와 실제 저장 구절 수 100% 일치
- [ ] **누락 구절 상세 분석**: 각 장별 누락 구절 목록 확인
- [ ] **누락 구절 즉시 복구**: 발견된 모든 누락 구절 처리 완료
- [ ] **재검증**: 복구 후 다시 한번 완전성 확인
- [ ] **Agent 보고 vs DB 실제 저장 대조**: 100% 일치 확인

### 최종 완료 후
- [ ] 전체 구절 처리 완료 확인
- [ ] 품질 검증 및 일관성 점검
- [ ] 성능 메트릭 수집 및 분석
- [ ] 최종 보고서 작성
- [ ] 다음 확장 작업 계획 수립

---

## 📚 참고 자료

- `PHILIPPIANS_3_PARALLEL_PROCESSING_REPORT.md`: 병렬 처리 성과 분석
- `ANALYSIS_OUTPUT_STANDARD.md`: Schema v2 분석 표준
- `database/schema_v2.sql`: 데이터베이스 스키마
- `agents/single_verse_analyzer.js`: 기본 분석 엔진

---

**문서 버전**: v1.0
**최종 업데이트**: 2025-09-29
**담당자**: Claude Code + Task Agents
**승인**: 프로젝트 리드

> 이 규칙은 모든 향후 콘텐츠 확장 작업에서 준수해야 하는 필수 가이드라인입니다.
> 규칙 위반 시 품질 저하 및 효율성 감소가 예상되므로 엄격한 준수가 요구됩니다.