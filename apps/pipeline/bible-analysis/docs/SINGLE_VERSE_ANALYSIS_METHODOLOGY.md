# 단일 구절 분석 방법론

**목적**: Claude Code가 직접 수행하는 고품질 성경 구절 분석 프로세스

**기준**: 창세기 1:2 템플릿 (90점 이상 품질 보장)

**특징**:
- ✅ API 사용 안 함 (Claude Code 토큰 활용)
- ✅ NIV JSON 직접 사용
- ✅ 품질 관문 시스템 (90점 미만 저장 안 함)
- ✅ 병렬 실행 준비 (함수 모듈화)

---

## 📋 6단계 워크플로우

### 1단계: 기존 분석 조회 (fetchExistingAnalysis)
```typescript
// Supabase에서 기존 분석 데이터 조회
const existing = await fetchExistingAnalysis("1 Corinthians 13:1");

// 포함 데이터:
// - verses (기본 구절 정보)
// - sentence_structures (문장 구조)
// - vocabulary (주요 단어)
// - contextual_explanations (문맥 설명)
// - korean_translations (한국어 번역)
// - special_explanations (특별 설명)
```

**목적**: 현재 분석 상태 파악

**출력**:
- 구절 ID
- NIV 원문
- 모든 분석 데이터

---

### 2단계: 품질 평가 (evaluateQuality)
```typescript
const score = evaluateQuality(existing);
// score: 0-100 범위의 점수
```

**평가 기준** (총 100점):

| 항목 | 배점 | 세부 기준 |
|------|------|-----------|
| **문장 구조** | 30점 | • 3개 이상: 20점<br>• 문법 설명 상세 (30자 이상): 10점 |
| **주요 단어** | 25점 | • 7개 이상: 15점<br>• 히브리어/그리스어 원어 포함: 10점 |
| **문맥 설명** | 20점 | • 500자 이상: 20점<br>• 300-500자: 15점<br>• 200-300자: 10점 |
| **한국어 번역** | 15점 | • 자연스러운 번역 존재: 15점 |
| **특별 설명** | 10점 | • 3개 이상: 10점<br>• 2개: 7점<br>• 1개: 4점 |

**품질 등급**:
- **우수 (90-100점)**: 재분석 불필요
- **양호 (70-89점)**: 재분석 권장
- **보통 (50-69점)**: 재분석 필수
- **미흡 (50점 미만)**: 재분석 필수

**결정**:
- **90점 이상**: 프로세스 종료 (이미 우수)
- **90점 미만**: 3단계로 진행

---

### 3단계: NIV 원문 추출 (getNIVText)
```typescript
const nivText = getNIVText("1 Corinthians 13:1");
// 출처: apps/pipeline/bible-analysis/source-data/NIV_Bible.json
```

**JSON 구조**:
```json
{
  "1 Corinthians": {
    "13": {
      "1": "If I speak in the tongues of men..."
    }
  }
}
```

**파싱 규칙**:
- 입력: "1 Corinthians 13:1"
- 분리: book="1 Corinthians", chapter="13", verse="1"
- 조회: nivBible[book][chapter][verse]

---

### 4단계: 분석 수행 (performAnalysis)

**핵심**: Claude Code가 창세기 1:2 템플릿을 기준으로 직접 작성

#### 4-1. 문장 구조 분석 (3-5개)

**필수 요소**:
```typescript
{
  sequence_order: 1,                              // 순서 (1, 2, 3, ...)
  semantic_classification: "조건절 - 능력 가정",   // 의미 분류
  original_text: "If I speak in the tongues...",  // 원문 그대로
  korean_translation: "만약 내가 방언으로...",     // 한글 번역
  grammatical_explanation: "조건절 if + 주어(I)..."  // 문법 설명 (30자 이상)
}
```

**작성 가이드**:
1. NIV 원문을 의미 단위로 분리 (문장, 주요 절)
2. 각 구조의 **의미적 분류** 명확히 (상태 묘사, 조건절, 결과절 등)
3. **문법 설명**에서 주어, 동사, 수식어 등 명시
4. **한글 번역**은 직역과 의역 조화

**예시 (1 Corinthians 13:1)**:
```typescript
[
  {
    sequence_order: 1,
    semantic_classification: "조건절 - 능력 가정",
    original_text: "If I speak in the tongues of men or of angels",
    korean_translation: "만약 내가 사람의 방언이나 천사의 방언으로 말한다 해도",
    grammatical_explanation: "조건절 if + 주어(I) + 동사(speak) + 전치사구(in the tongues of men or of angels). 'or'로 연결된 두 명사구가 가능한 방언의 범위를 확장하여 극단적인 경우를 가정함"
  },
  // ... 2-4개 더
]
```

#### 4-2. 주요 단어 분석 (7-10개)

**필수 요소**:
```typescript
{
  word: "love",                               // 영어 단어
  ipa_pronunciation: "[lʌv]",                // IPA 발음 (대괄호 포함)
  korean_pronunciation: "러브",               // 한글 발음
  part_of_speech: "명사",                    // 품사
  definition_korean: "사랑 (그리스어 'ἀγάπη'(agape)로, 조건 없는 희생적 사랑...)",  // ⚠️ 반드시 원어 포함!
  usage_note: "1 Corinthians 13:1에서 사용됨"  // 구절 표시
}
```

**작성 가이드**:
1. NIV 원문에서 **핵심 단어** 7-10개 선정
2. **IPA 발음** 정확히 작성 (온라인 사전 참조)
3. **한글 발음** 자연스럽게 표기
4. **⚠️ 중요**: definition_korean에 반드시 **히브리어/그리스어 원어**와 그 의미 포함
5. 신약 = 그리스어, 구약 = 히브리어

**히브리어/그리스어 원어 작성 패턴**:
```
"단어 의미 (그리스어/히브리어 '원어'(transliteration)로, 원어의 뜻을 설명하며, 성경적 맥락에서의 의미를 부연)"
```

**예시**:
```typescript
{
  word: "love",
  ipa_pronunciation: "[lʌv]",
  korean_pronunciation: "러브",
  part_of_speech: "명사",
  definition_korean: "사랑 (그리스어 'ἀγάπη'(agape)로, 조건 없는 희생적 사랑을 의미함. 고린도전서 13장 전체의 주제이며, 단순한 감정이 아니라 의지적이고 행동으로 나타나는 사랑. 모든 은사보다 탁월한 덕목)",
  usage_note: "1 Corinthians 13:1에서 사용됨"
}
```

#### 4-3. 문맥 설명 (300자 이상, 500자 권장)

**필수 요소**:
```typescript
{
  integrated_explanation: "장문의 통합 설명 (300-500자 이상)"
}
```

**작성 가이드**:
1. **역사적 배경**: 당시 시대, 지역, 문화적 맥락
2. **신학적 의미**: 구절의 신학적 메시지와 의미
3. **문학적 특징**: 수사법, 문학 구조, 저자의 의도
4. **히브리어/그리스어 분석**: 원어의 뉘앙스와 의미
5. **관련 구절 참조** (있는 경우)

**패턴**:
```
[구절]은/는 [전체적 맥락]이다. [역사적 배경 설명].

[원어 분석] (그리스어/히브리어 "원어"로...).

[신학적 의미]. [문학적 특징].

[관련 구절 참조 및 적용].
```

**예시** (1 Corinthians 13:1, 1290자):
```
1 Corinthians 13:1은 사도 바울이 고린도교회에 보낸 편지 중 가장 유명한 "사랑 장"의 시작 구절이다. 고린도교회는 방언의 은사를 특히 중요하게 여겼으나, 바울은 이 구절을 통해 사랑이 없는 은사는 무의미함을 강력하게 선언한다.

"사람의 방언이나 천사의 방언"은 히브리적 과장법으로, 가능한 모든 방언, 즉 인간과 천사의 언어 전체를 포괄한다. 당시 유대교 전승에서는 천사들이 특별한 언어로 하나님을 찬양한다고 믿었으며, 바울은 이러한 최고 수준의 영적 의사소통 능력까지도 사랑 없이는 무가치함을 역설한다.

"울리는 징"(그리스어 χαλκός ἠχῶν)과 "요란한 꽹과리"(κύμβαλον ἀλαλάζον)는 당시 고린도 지역의 이교도 신전 예배에서 사용되던 시끄러운 악기들을 가리킨다. 특히 Cybele 여신 숭배에서는 광란적인 예배 중에 징과 꽹과리를 요란하게 울렸는데, 바울은 이러한 이미지를 사용하여 사랑 없는 방언이 이교도의 무의미한 소음과 다를 바 없음을 비유적으로 표현한다.

문학적으로 이 구절은 "If... but... I am only..."의 조건-대조-결과 구조를 사용하여, 은사와 사랑의 관계를 명확히 대비시킨다. 이는 13장 전체에서 반복되는 수사적 패턴의 시작으로, 바울이 사랑의 절대적 우위성을 강조하는 문학적 기교를 보여준다.

신학적으로 이 구절은 은사중심주의에 대한 경고이자, 사랑이 모든 영적 활동의 본질임을 선언한다. 아가페 사랑 없이는 가장 위대한 은사조차도 하나님께 받아들여지지 않으며, 성도의 덕을 세우지 못한다는 바울의 핵심 메시지가 담겨 있다.
```

#### 4-4. 한국어 번역 (자연스러운 통합 번역)

**필수 요소**:
```typescript
{
  natural_translation: "만약 내가 사람의 방언이나 천사의 방언으로 말한다 해도, 사랑이 없다면 나는 단지 울리는 징이나 요란한 꽹과리에 불과하다."
}
```

**작성 가이드**:
1. 문장 구조들의 한글 번역을 하나로 통합
2. 직역과 의역을 조화
3. 한국어로 읽기 쉬운 문장 구조
4. 원문의 뉘앙스 보존

#### 4-5. 특별 설명 (2-3개, 다양한 관점)

**필수 요소**:
```typescript
{
  explanation_type: "그리스어 문법",  // 또는 "히브리어 문법", "신학적 해석", "역사적 배경", "문학적 기교" 등
  content: "바울은 가정법(ἐὰν + 접속법)을 사용하여..."
}
```

**작성 가이드**:
1. **다양한 관점** 제시 (문법, 신학, 역사, 문학 등)
2. **구체적이고 유익한** 내용
3. **각 설명마다 다른 유형** 사용

**예시** (1 Corinthians 13:1):
```typescript
[
  {
    explanation_type: "그리스어 문법",
    content: "바울은 가정법(ἐὰν + 접속법)을 사용하여 실현 가능한 조건을 제시하지만, 'ἀγάπην δὲ μὴ ἔχω'(사랑이 없다면)라는 대조절을 통해 그 모든 능력이 무의미해질 수 있음을 경고한다. 'μόνον'(only, 단지)이 강조 위치에 놓여 사랑 없는 은사의 완전한 무가치함을 강조한다."
  },
  {
    explanation_type: "신학적 해석",
    content: "이 구절은 은사와 사랑의 관계를 정립한다. 방언을 포함한 모든 은사는 사랑이라는 토대 위에서만 진정한 가치를 가진다. 사랑(ἀγάπη)은 단순한 감정이 아니라 희생적이고 자기 부인적인 행동으로, 고린도전서 13:4-7에서 더 자세히 설명된다. 이는 은사중심적 교회에 대한 바울의 근본적인 교정이다."
  },
  {
    explanation_type: "역사적 배경",
    content: "고대 고린도는 다양한 이교 신전들이 있던 도시였으며, 특히 Cybele와 Dionysus 숭배에서 징과 꽹과리를 사용한 광란적 예배가 행해졌다. 바울은 고린도 신자들에게 익숙한 이러한 이미지를 사용하여, 사랑 없는 영적 은사가 이교도의 무의미한 의식과 본질적으로 다르지 않음을 생생하게 전달한다."
  }
]
```

---

### 5단계: 재평가 (evaluateQuality)
```typescript
const newScore = evaluateQuality(newAnalysis);
```

**품질 관문**:
- **90점 이상**: 6단계로 진행 (DB 저장)
- **90점 미만**: 저장 건너뛰기, 분석 수정 필요

**출력**:
- 새 분석 품질 점수
- 저장 여부 결정

---

### 6단계: DB 저장 (saveToDatabase)

**저장 프로세스**:
1. **기존 데이터 삭제** (중복 방지)
   - sentence_structures
   - vocabulary
   - contextual_explanations
   - korean_translations
   - special_explanations

2. **새 데이터 삽입**
   - 각 테이블에 순차 삽입
   - 에러 처리 및 로깅

**트랜잭션 보장**:
- 각 테이블 저장 성공/실패 독립 처리
- 에러 발생 시에도 다른 테이블 저장 계속

---

## 🎯 품질 보증 시스템

### 자동 품질 평가
```typescript
function evaluateQuality(analysis: any): number {
  // 1. 문장 구조 (30점)
  // 2. 주요 단어 (25점) - 원어 포함 필수
  // 3. 문맥 설명 (20점) - 길이와 깊이
  // 4. 한국어 번역 (15점)
  // 5. 특별 설명 (10점)

  return score; // 0-100
}
```

### 품질 기준 체크리스트

#### ✅ 우수 분석 (90-100점)
- [ ] 문장 구조 3개 이상, 모두 상세한 문법 설명
- [ ] 주요 단어 7-10개, **모두 히브리어/그리스어 원어 포함**
- [ ] 문맥 설명 500자 이상, 역사/신학/문학 통합
- [ ] 자연스러운 한국어 번역
- [ ] 특별 설명 3개, 다양한 관점

#### ⚠️ 보통 분석 (50-69점)
- 문장 구조 1-2개
- 주요 단어 3-6개, 일부만 원어 포함
- 문맥 설명 200-300자
- 기계적인 번역
- 특별 설명 1-2개

#### ❌ 미흡 분석 (50점 미만)
- 문장 구조 대부분 누락
- 주요 단어 3개 미만
- 문맥 설명 200자 미만
- 번역 누락
- 특별 설명 없음

---

## 📊 실행 예시

### 성공 사례: 1 Corinthians 13:1

```bash
$ npx ts-node bible-analysis/core/analyze-single-verse.ts "1 Corinthians 13:1"

================================================================================
🔍 단일 절 분석 프로세스: 1 Corinthians 13:1
================================================================================

📖 1단계: "1 Corinthians 13:1" 기존 분석 조회 중...
   ✅ 구절 ID: 14428
   📝 원문: If I speak in the tongues of men or of angels...

📊 2단계: 품질 평가 중...
   📈 현재 품질 점수: 40/100
   ⚠️  품질이 기준 미달입니다 (90점 미만). 재분석 필요.

📚 3단계: NIV 원문 추출 중...
   ✅ NIV 원문: "If I speak in the tongues of men..."

✍️  4단계: 분석 수행 중...
   🤖 Claude가 창세기 1:2 템플릿 기준으로 분석을 작성합니다...

📊 5단계: 새 분석 품질 평가 중...
   📈 새 분석 품질 점수: 100/100
   ✅ 우수한 품질입니다! (90점 이상)

💾 6단계: 데이터베이스 저장 중...
   ✅ 문장 구조 저장 완료 (3개)
   ✅ 주요 단어 저장 완료 (8개)
   ✅ 문맥 설명 저장 완료
   ✅ 한국어 번역 저장 완료
   ✅ 특별 설명 저장 완료 (3개)

================================================================================
✅ 완료! 소요 시간: 0.94초
   이전 점수: 40/100 → 새 점수: 100/100
================================================================================
```

### 재분석 불필요 사례: Genesis 1:2

```bash
$ npx ts-node bible-analysis/core/analyze-single-verse.ts "Genesis 1:2"

📊 2단계: 품질 평가 중...
   📈 현재 품질 점수: 95/100
   ✅ 이미 우수한 품질입니다 (90점 이상). 재분석 불필요.

✅ 완료! 소요 시간: 0.12초
```

---

## 🔧 스크립트 사용법

### 기본 실행
```bash
cd apps/pipeline
npx ts-node bible-analysis/core/analyze-single-verse.ts "1 Corinthians 13:1"
```

### 프로그래밍 방식
```typescript
import { analyzeSingleVerse } from './bible-analysis/core/analyze-single-verse';

await analyzeSingleVerse("1 Corinthians 13:1");
```

### 병렬 실행 준비
```typescript
// 여러 구절을 병렬로 처리
const verses = [
  "1 Corinthians 13:1",
  "1 Corinthians 13:2",
  "1 Corinthians 13:3"
];

await Promise.all(
  verses.map(ref => analyzeSingleVerse(ref))
);
```

---

## ⚠️ 주의사항

### 1. API 사용 금지
- ✅ Claude Code 토큰 사용 (직접 작성)
- ✅ NIV JSON 직접 읽기
- ✅ Supabase 직접 연결
- ❌ Anthropic API 호출
- ❌ 외부 웹 API
- ❌ 웹 검색

### 2. 품질 기준 준수
- 반드시 90점 이상만 저장
- 히브리어/그리스어 원어 필수 포함
- 문맥 설명 300자 이상

### 3. 템플릿 기준
- 창세기 1:2를 품질 표준으로 사용
- 같은 수준의 깊이와 상세함 유지

---

## 📚 참고 문서

- **템플릿**: `apps/pipeline/bible-analysis/templates/ANALYSIS_TEMPLATE.md`
- **스크립트**: `apps/pipeline/bible-analysis/core/analyze-single-verse.ts`
- **품질 기준**: 창세기 1:2 분석 참조

---

## 🚀 다음 단계: 병렬 실행

이 방법론을 기반으로 병렬 실행 전략을 수립하여 여러 구절을 동시에 분석할 수 있습니다.

다음 문서 참조: `PARALLEL_ANALYSIS_STRATEGY.md`
