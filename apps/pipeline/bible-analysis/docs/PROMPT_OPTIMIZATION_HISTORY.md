# 프롬프트 최적화 히스토리

**작성일**: 2025-10-17
**작성자**: Bible Analysis Team

---

## 📋 목차

1. [문제 발생 배경](#문제-발생-배경)
2. [증상 및 로그 분석](#증상-및-로그-분석)
3. [원인 분석](#원인-분석)
4. [해결 과정](#해결-과정)
5. [개선 결과](#개선-결과)
6. [교훈 및 권장사항](#교훈-및-권장사항)

---

## 문제 발생 배경

### 발생 시점
2025년 10월 17일, analyzer-app으로 로마서 16장 분석 중

### 발생 상황
- analyzer-app에서 여러 구절을 병렬로 자동 분석 중
- 일부 구절에서 JSON 파일 생성 실패
- 5분 타임아웃 발생

---

## 증상 및 로그 분석

### 에러 로그
```
[18835:1017/141527.943234:INFO:CONSOLE(477)] "💥 파일 생성 실패: 로마서 16장 7절"
[18835:1017/141528.038016:INFO:CONSOLE(561)] "⏱️ 타임아웃: 로마서 16장 24절 (JSON 파일 생성 대기)"
[18835:1017/141528.038096:INFO:CONSOLE(477)] "💥 파일 생성 실패: 로마서 16장 24절"
[18835:1017/141528.122856:INFO:CONSOLE(561)] "⏱️ 타임아웃: 로마서 16장 9절 (JSON 파일 생성 대기)"
[18835:1017/141528.206979:INFO:CONSOLE(561)] "⏱️ 타임아웃: 로마서 16장 17절 (JSON 파일 생성 대기)"
[18835:1017/141528.374227:INFO:CONSOLE(561)] "⏱️ 타임아웃: 로마서 16장 18절 (JSON 파일 생성 대기)"
```

### 실패 패턴 분석

#### 실패한 구절
- 로마서 16:7, 9, 17, 18 - **NIV 원문 존재함** ✅
- 로마서 16:24 - **NIV 원문 없음** ❌

#### 의외의 발견
**NIV 원문이 있는 구절들도 실패**했습니다!
- 16:7: "Greet Andronicus and Junia, my fellow Jews who hav..."
- 16:9: "Greet Urbanus, our co-worker in Christ, and my dea..."
- 16:17: "I urge you, brothers and sisters, to watch out for..."
- 16:18: "For such people are not serving our Lord Christ, b..."

이는 **"없음" 처리 문제가 아니라 프롬프트 자체의 문제**임을 의미합니다.

---

## 원인 분석

### 1. 프롬프트 복잡도 문제 🔴

#### 기존 프롬프트 분석
```bash
$ wc -l ANALYZE_VERSE_PROMPT.txt
205 ANALYZE_VERSE_PROMPT.txt
```

**205줄의 장문 프롬프트**로 구성되어 있었음:
- 필수 규칙 (10줄)
- 작업 단계 (30줄)
- JSON 구조 예시 (80줄)
- 품질 기준 (40줄)
- 실행 방법 (30줄)
- 출력 예시 (15줄)

#### Haiku 모델의 한계
- **Claude Haiku**: 빠르고 저렴하지만 단순한 작업에 최적화
- **복잡한 장문 프롬프트**: Haiku가 모든 지시사항을 완벽히 따르기 어려움
- **결과**: 중간 단계 누락, Write 도구 호출 건너뛰기 등

### 2. 조건부 로직 추가로 복잡도 증가 🔴

#### "없음" 처리 로직 추가
사용자가 "성경에 없는 절 처리" 요청 후:
- NIV 원문이 **있을 때** 처리 방법 (60줄)
- NIV 원문이 **없을 때** 처리 방법 (20줄)
- 두 가지 JSON 구조 예시 추가

**결과**: 프롬프트가 더욱 복잡해지고 조건부 로직이 추가되어 Haiku가 혼란스러워함

### 3. 핵심 작업 집중도 저하 🔴

#### 너무 많은 부가 정보
- 품질 평가 기준 (100점 만점 시스템)
- 출력 형식 예시 (성공/실패 케이스)
- 특별 설명, 문법 설명 등

**결과**: Claude가 핵심 작업(Read → 분석 → Write)에 집중하지 못함

### 4. 실제 동작 예상

#### Haiku의 행동 패턴 (추정)
1. 긴 프롬프트를 읽음
2. "분석을 수행해야 하는구나" 이해
3. Read 도구는 사용
4. 분석 내용은 생성
5. **하지만 Write 도구 호출을 잊어버림** 🔴
6. 또는 "사용자에게 확인을 구해야 하나?" 망설임
7. 5분 타임아웃 발생

---

## 해결 과정

### 1단계: 문제 진단

#### 확인 작업
```bash
# NIV 원문 존재 여부 확인
$ node -e "
const niv = require('./NIV_Bible.json');
const verses = ['7', '9', '17', '18', '24'];
console.log('로마서 16장 확인:');
verses.forEach(v => {
  const text = niv['Romans']['16'][v];
  console.log(\`16:\${v} - \${text ? '존재' : '❌ 없음'}\`);
});
"

# 결과: 7, 9, 17, 18은 존재, 24만 없음
# 결론: "없음" 처리가 문제가 아님!
```

### 2단계: 프롬프트 분석

#### 복잡도 측정
- **총 길이**: 205줄
- **조건부 로직**: 2개 분기 (있을 때 / 없을 때)
- **JSON 예시**: 2개 (80줄)
- **부가 설명**: 약 60줄

**결론**: Haiku 모델에게 너무 복잡함

### 3단계: 간소화 프롬프트 설계

#### 설계 원칙
1. ✅ **핵심만 남기기**: Read → 분석 → Write
2. ✅ **조건부 로직 단순화**: JSON 구조만 2개 제시
3. ✅ **부가 설명 제거**: 품질 기준, 출력 예시 등 삭제
4. ✅ **명확한 지시**: "즉시 실행!", "확인 요청 금지!"

#### 새 프롬프트 작성
```bash
$ cat > ANALYZE_VERSE_PROMPT_COMPACT.txt
# 67줄로 단축 (67% 감소!)
```

### 4단계: analyzer-app 수정

#### 프롬프트 경로 변경
```javascript
// renderer.js
- const PROMPT_PATH = path.join(BASE_DIR, 'ANALYZE_VERSE_PROMPT.txt');
+ const PROMPT_PATH = path.join(BASE_DIR, 'ANALYZE_VERSE_PROMPT_COMPACT.txt');
```

### 5단계: 기존 프롬프트 백업

#### 문서화
- 원본 프롬프트: `docs/ANALYZE_VERSE_PROMPT_FULL_VERSION.md`로 백업
- 아카이브 이유 및 개선 버전 설명 추가
- 향후 참고용으로 보관

---

## 개선 결과

### 프롬프트 비교

| 항목 | 기존 (Full) | 개선 (Compact) | 변화 |
|------|-------------|----------------|------|
| **줄 수** | 205줄 | 67줄 | **67% 감소** ✅ |
| **JSON 예시** | 2개 (상세) | 2개 (간소) | 가독성 향상 ✅ |
| **품질 기준** | 100줄 | 10줄 | 핵심만 유지 ✅ |
| **조건부 로직** | 복잡 | 단순 | 이해도 향상 ✅ |
| **부가 설명** | 많음 | 최소 | 집중도 향상 ✅ |

### 예상 효과

#### ✅ 성공률 향상
- Haiku가 핵심 작업에 집중
- Write 도구 호출 누락 방지
- 타임아웃 감소

#### ✅ 처리 속도 향상
- 프롬프트가 짧아져 토큰 소비 감소
- 분석 시간 단축

#### ✅ 안정성 향상
- 단순한 지시사항으로 실수 방지
- "없음" 케이스도 명확히 처리

### 테스트 방법

```bash
# analyzer-app 재시작
cd analyzer-app
npm start

# 실패했던 구절 재분석
# 1. "🔄 실패한 것만 재분석" 버튼 클릭
# 2. 로마서 16:7, 9, 17, 18 재시도
# 3. 로그 확인: "✅ 파일 생성 확인" 메시지
```

---

## 교훈 및 권장사항

### 1. AI 모델별 프롬프트 전략 🎯

#### Claude Haiku
- ✅ **짧고 명확한** 프롬프트 (50-100줄)
- ✅ **단순한 작업** (파일 생성, 간단한 분석)
- ✅ **조건부 로직 최소화**
- ❌ 복잡한 장문 프롬프트
- ❌ 다단계 조건 분기

#### Claude Sonnet/Opus
- ✅ 복잡한 프롬프트도 처리 가능
- ✅ 상세한 품질 기준 따르기
- ✅ 다단계 로직 수행
- 💰 비용은 높지만 품질 보장

### 2. 프롬프트 설계 원칙 📝

#### KISS 원칙 (Keep It Simple, Stupid)
1. **핵심만 남기기**: 필수 작업만 명시
2. **예시 최소화**: 꼭 필요한 것만
3. **조건부 단순화**: A or B, 그 이상은 복잡

#### 명확성 우선
1. **즉시 실행 강조**: "지금 바로!", "확인 요청 금지!"
2. **도구 호출 명시**: "반드시 Write 도구 사용!"
3. **출력 형식 간소**: 핵심 정보만

### 3. 실패 대응 전략 🔧

#### 문제 발생 시 순서
1. **로그 확인**: 어디서 멈췄는가?
2. **원인 분석**: 프롬프트? 모델? 데이터?
3. **간소화 시도**: 복잡도 줄이기
4. **모델 변경 고려**: Haiku → Sonnet
5. **타임아웃 조정**: 필요시 증가

#### 점진적 개선
- ❌ 처음부터 완벽한 프롬프트 작성
- ✅ 최소 기능으로 시작 → 점진적 개선
- ✅ A/B 테스트: 두 버전 비교

### 4. 문서화의 중요성 📚

#### 이번 사례에서 배운 점
- ✅ **원본 보존**: 백업 문서로 저장
- ✅ **변경 이유 기록**: 히스토리 문서 작성
- ✅ **비교 자료**: 개선 전후 비교
- ✅ **미래 참고**: 비슷한 문제 재발 방지

---

## 부록: 프롬프트 파일 구조

### 현재 파일 목록

```
bible-analysis/
├── ANALYZE_VERSE_PROMPT.txt                      # 원본 (사용 안 함)
├── ANALYZE_VERSE_PROMPT_COMPACT.txt              # 현재 사용 중 ✅
│
├── docs/
│   ├── ANALYZE_VERSE_PROMPT_FULL_VERSION.md      # 원본 백업 📚
│   └── PROMPT_OPTIMIZATION_HISTORY.md            # 이 문서 📖
│
└── analyzer-app/
    └── src/
        └── renderer.js                            # COMPACT 버전 사용
```

### 파일 용도

| 파일 | 용도 | 상태 |
|------|------|------|
| `ANALYZE_VERSE_PROMPT.txt` | 원본 (205줄) | 사용 안 함 |
| `ANALYZE_VERSE_PROMPT_COMPACT.txt` | 간소화 (67줄) | **현재 사용 중** ✅ |
| `docs/ANALYZE_VERSE_PROMPT_FULL_VERSION.md` | 원본 백업 | 아카이브 |
| `docs/PROMPT_OPTIMIZATION_HISTORY.md` | 변경 히스토리 | 이 문서 |

---

## 결론

### 핵심 요약

1. **문제**: 205줄 복잡한 프롬프트로 Haiku가 Write 도구 호출 누락
2. **원인**: 프롬프트 복잡도 + 조건부 로직 + 부가 설명 과다
3. **해결**: 67줄 간소화 프롬프트로 핵심만 남김
4. **결과**: 성공률 향상, 타임아웃 감소 예상

### 향후 계획

- [ ] 간소화 프롬프트로 테스트 진행
- [ ] 성공률 모니터링 (목표: 95% 이상)
- [ ] 필요시 추가 최적화
- [ ] 다른 성경 책 분석 시 적용

---

**작성**: Bible Analysis Team  
**최종 수정**: 2025-10-17  
**버전**: 1.0
